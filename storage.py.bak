# storage.py
import streamlit as st
import json

def sync_from_browser():
    """Injects JavaScript to sync localStorage -> query params (so Streamlit can read)"""
    st.markdown("""
    <script>
    const savedState = localStorage.getItem("agri_state");
    if (savedState) {
        const params = new URLSearchParams(window.location.search);
        if (!params.has("user_state")) {
            params.set("user_state", savedState);
            const newUrl = window.location.pathname + '?' + params.toString();
            window.location.replace(newUrl);
        }
    }
    </script>
    """, unsafe_allow_html=True)

def load_state():
    """Reads state from query params"""
    params = st.query_params
    if "user_state" in params:
        try:
            return json.loads(params["user_state"])
        except:
            return None
    return None

def save_state(state):
    """Injects JS to write to browser localStorage"""
    js = f"""
    <script>
    localStorage.setItem("agri_state", JSON.stringify({json.dumps(state)}));
    </script>
    """
    st.markdown(js, unsafe_allow_html=True)

def clear_state():
    """Removes login data from localStorage (used during logout)"""
    st.markdown("""
    <script> localStorage.removeItem("agri_state"); </script>
    """, unsafe_allow_html=True)